<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PHP基础知识学习(03)--变量 | 相惜恨离</title>
    <meta property="og:title" content="PHP基础知识学习(03)--变量 - 相惜恨离">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-04-02T09:32:12&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-04-02T09:32:12&#43;08:00'>
        
    <meta name="Keywords" content="php,laravel,golang,go语言,go语言笔记,java,博客,项目管理,python,软件架构,公众号,小程序">
    <meta name="description" content="PHP基础知识学习(03)--变量">
        
    <meta name="author" content="相惜恨离">
    <meta property="og:url" content="https://xiangxihenli.github.io/post/php-basic03/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
        <link rel="stylesheet" href='/css/custom.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://xiangxihenli.github.io">
                        相惜恨离
                    </a>
                
                <p class="description">专注于PHP、Java、Go语言(golang)、移动互联网、项目管理、软件架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://xiangxihenli.github.io">首页</a>
                    
                    <a  href="https://xiangxihenli.github.io/tutorial" title="教程">教程</a>
                    
                    <a  href="https://xiangxihenli.github.io/archives" title="归档">归档</a>
                    
                    <a  href="https://xiangxihenli.github.io/about" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -230px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 17px;
        font-weight: 400;
        text-transform: uppercase;
         
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#变量">变量</a></li>
    <li><a href="#php5中zval">PHP5中zval</a></li>
    <li><a href="#php7中zval">PHP7中zval</a></li>
    <li><a href="#变量类型">变量类型</a></li>
    <li><a href="#变量的内存管理">变量的内存管理</a></li>
    <li><a href="#引用计数">引用计数</a></li>
    <li><a href="#写时复制">写时复制</a></li>
    <li><a href="#变量回收">变量回收</a></li>
    <li><a href="#垃圾回收">垃圾回收</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>

    <article class="post">
        <header>
            <h1 class="post-title">PHP基础知识学习(03)--变量</h1>
        </header>
        <date class="post-meta meta-date">
            2020年4月2日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='https://xiangxihenli.github.io/categories/PHP%E5%9F%BA%E7%A1%80'>PHP基础</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="变量">变量</h2>
<p>大多数编程语言都有变量，变量通常有三个属性，变量名、变量值、变量类型。PHP是一种弱类型语言，变量可以在实际处理过程中进行隐式的转换。这一特性让开发变得十分便利。</p>
<p>在官方的PHP实现内部，所有变量使用同一种结构<strong><code>zval</code></strong>来保存，这个结构能表示PHP中的各种数据类型。
不仅包含变量的值，也包含变量的类型。这就是PHP语言的核心。</p>
<h2 id="php5中zval">PHP5中zval</h2>
<p>在PHP5内核中，通过zval这个结构体存储变量，有四个成员：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">struct</span> _zval_struct {
	zvalue_value value;	<span style="color:#998;font-style:italic">//变量的值 
</span><span style="color:#998;font-style:italic"></span>	zend_uint refcount__gc; <span style="color:#998;font-style:italic">// 表示引用次数 默认为1
</span><span style="color:#998;font-style:italic"></span>	zend_uchar type;	<span style="color:#998;font-style:italic">//变量当前的数据类型 
</span><span style="color:#998;font-style:italic"></span>	zend_uchar is_ref__gc; <span style="color:#998;font-style:italic">// 表示变量是否引用
</span><span style="color:#998;font-style:italic"></span>};
<span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">struct</span> _zval_struct zval;

<span style="color:#998;font-style:italic">//在Zend/zend_types.h里定义的：
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">typedef</span> <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">int</span> zend_uint;
<span style="color:#000;font-weight:bold">typedef</span> <span style="color:#458;font-weight:bold">unsigned</span> <span style="color:#458;font-weight:bold">char</span> zend_uchar;
</code></pre></td></tr></table>
</div>
</div><p>变量的值zvalue_value，是一个union。结构如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">union</span> _zvalue_value {
	<span style="color:#458;font-weight:bold">long</span> lval;	<span style="color:#998;font-style:italic">// 整数类型的值
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#458;font-weight:bold">double</span> dval;	<span style="color:#998;font-style:italic">// 浮点数类型的值
</span><span style="color:#998;font-style:italic"></span>	<span style="color:#000;font-weight:bold">struct</span> {
		<span style="color:#458;font-weight:bold">char</span> <span style="color:#000;font-weight:bold">*</span>val;  <span style="color:#998;font-style:italic">// 字符串类型的值
</span><span style="color:#998;font-style:italic"></span>		<span style="color:#458;font-weight:bold">int</span> len; <span style="color:#998;font-style:italic">// 字符串类型的长度
</span><span style="color:#998;font-style:italic"></span>	} str; <span style="color:#998;font-style:italic">// 字符串类型
</span><span style="color:#998;font-style:italic"></span>	HashTable <span style="color:#000;font-weight:bold">*</span>ht;	<span style="color:#998;font-style:italic">// 数组类型 使用HashTable
</span><span style="color:#998;font-style:italic"></span>	zend_object_value obj; <span style="color:#998;font-style:italic">// 对象类型
</span><span style="color:#998;font-style:italic"></span>} zvalue_value;
</code></pre></td></tr></table>
</div>
</div><p>在这两个结构体上，PHP实现了8种变量。IS_NULL、IS_BOOL、IS_LONG、IS_DOUBLE、IS_ARRAY、IS_OBJECT、IS_RESOURCE。</p>
<p>zval是PHP中数据结构使用的结构体，值存在zvalue_value，zvalue_value中定义了5种常用的数据类型。</p>
<p>PHP5中的zval有几个问题：</p>
<ol>
<li>zvalue_value中zend_object_value占用的空间较大，使用指针代替。</li>
<li>zval的结构体变量比较固定，不利于扩展。</li>
<li>zval obj需要自身维护一个refcount</li>
<li>因为引用计数是作用在zval的, 导致如果要拷贝一个字符串类型的zval, 只能复制这个字符串. 当把一个zval的字符串作为key添加到一个数组里的时候, 只能复制这个字符串.</li>
<li>写时分离存在性能问题</li>
</ol>
<p>这些问题在php7中得到了解决。</p>
<h2 id="php7中zval">PHP7中zval</h2>
<p>接下来重点说一下PHP7中的变量结构：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#998;font-style:italic">//zend_types.h
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">struct</span> _zval_struct  zval;

<span style="color:#000;font-weight:bold">struct</span> _zval_struct {
    zend_value        value; <span style="color:#998;font-style:italic">//变量实际的value
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">union</span> {
        <span style="color:#000;font-weight:bold">struct</span> {
            ZEND_ENDIAN_LOHI_4( <span style="color:#998;font-style:italic">//兼容大小字节序，小字节序就是下面的顺序，大字节序则下面4个顺序翻转
</span><span style="color:#998;font-style:italic"></span>                zend_uchar    type,         <span style="color:#998;font-style:italic">//变量类型
</span><span style="color:#998;font-style:italic"></span>                zend_uchar    type_flags,  <span style="color:#998;font-style:italic">//类型掩码，不同的类型有不同的几种属性，内存管理用到
</span><span style="color:#998;font-style:italic"></span>                zend_uchar    const_flags,
                zend_uchar    reserved)     <span style="color:#998;font-style:italic">//call info，zend执行流程会用到
</span><span style="color:#998;font-style:italic"></span>        } v;
        uint32_t type_info; <span style="color:#998;font-style:italic">//上面4个值的组合值，可以直接根据type_info取到4个对应位置的值
</span><span style="color:#998;font-style:italic"></span>    } u1;
    <span style="color:#000;font-weight:bold">union</span> {
        uint32_t     var_flags;
        uint32_t     next;                 <span style="color:#998;font-style:italic">//哈希表中解决哈希冲突时用到
</span><span style="color:#998;font-style:italic"></span>        uint32_t     cache_slot;           <span style="color:#998;font-style:italic">/* literal cache slot */</span>
        uint32_t     lineno;               <span style="color:#998;font-style:italic">/* line number (for ast nodes) */</span>
        uint32_t     num_args;             <span style="color:#998;font-style:italic">/* arguments number for EX(This) */</span>
        uint32_t     fe_pos;               <span style="color:#998;font-style:italic">/* foreach position */</span>
        uint32_t     fe_iter_idx;          <span style="color:#998;font-style:italic">/* foreach iterator index */</span>
    } u2; <span style="color:#998;font-style:italic">//一些辅助值
</span><span style="color:#998;font-style:italic"></span>};


<span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">union</span> _zend_value {
    zend_long         lval;    <span style="color:#998;font-style:italic">//int整形
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">double</span>            dval;    <span style="color:#998;font-style:italic">//浮点型
</span><span style="color:#998;font-style:italic"></span>    zend_refcounted  <span style="color:#000;font-weight:bold">*</span>counted;
    zend_string      <span style="color:#000;font-weight:bold">*</span>str;     <span style="color:#998;font-style:italic">//string字符串
</span><span style="color:#998;font-style:italic"></span>    zend_array       <span style="color:#000;font-weight:bold">*</span>arr;     <span style="color:#998;font-style:italic">//array数组
</span><span style="color:#998;font-style:italic"></span>    zend_object      <span style="color:#000;font-weight:bold">*</span>obj;     <span style="color:#998;font-style:italic">//object对象
</span><span style="color:#998;font-style:italic"></span>    zend_resource    <span style="color:#000;font-weight:bold">*</span>res;     <span style="color:#998;font-style:italic">//resource资源类型
</span><span style="color:#998;font-style:italic"></span>    zend_reference   <span style="color:#000;font-weight:bold">*</span>ref;     <span style="color:#998;font-style:italic">//引用类型，通过&amp;$var_name定义的
</span><span style="color:#998;font-style:italic"></span>    zend_ast_ref     <span style="color:#000;font-weight:bold">*</span>ast;     <span style="color:#998;font-style:italic">//下面几个都是内核使用的value
</span><span style="color:#998;font-style:italic"></span>    zval             <span style="color:#000;font-weight:bold">*</span>zv;
    <span style="color:#458;font-weight:bold">void</span>             <span style="color:#000;font-weight:bold">*</span>ptr;
    zend_class_entry <span style="color:#000;font-weight:bold">*</span>ce;
    zend_function    <span style="color:#000;font-weight:bold">*</span>func;
    <span style="color:#000;font-weight:bold">struct</span> {
        uint32_t w1;
        uint32_t w2;
    } ww;
} zend_value;
</code></pre></td></tr></table>
</div>
</div><p><code>zval</code>结构比较简单，内嵌一个union类型的<code>zend_value</code>保存具体变量类型的值或指针，<code>zval</code>中有两个union：<code>u1</code>、<code>u2</code>。</p>
<p><code>u1</code>： 它的意义比较直观，变量的类型就通过u1.v.type区分，另外一个值type_flags为类型掩码，在变量的内存管理、gc机制中会用到。</p>
<p><code>u2</code>： 这个值纯粹是个辅助值，假如zval只有:value、u1两个值，整个zval的大小也会对齐到16byte，既然不管有没有u2大小都是16byte，
把多余的4byte拿出来用于一些特殊用途还是很划算的，比如next在哈希表解决哈希冲突时会用到，还有fe_pos在foreach会用到。</p>
<p>从<code>zend_value</code>可以看出，除<code>long</code>、<code>double</code>类型直接存储值外，其它类型都为指针，指向各自的结构。</p>
<h2 id="变量类型">变量类型</h2>
<p>变量的类型通过zval.u1.type来表示：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#998;font-style:italic">/* regular data types */</span>
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_UNDEF                    0</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_NULL                     1</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_FALSE                    2</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_TRUE                     3</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_LONG                     4</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_DOUBLE                   5</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_STRING                   6</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_ARRAY                    7</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_OBJECT                   8</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_RESOURCE                 9</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_REFERENCE                10</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#998;font-style:italic">/* constant expressions */</span>
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_CONSTANT                 11</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_CONSTANT_AST             12</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#998;font-style:italic">/* fake types */</span>
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define _IS_BOOL                    13</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_CALLABLE                 14</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#998;font-style:italic">/* internal types */</span>
<span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_INDIRECT                 15</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#</span><span style="color:#999;font-weight:bold;font-style:italic">define IS_PTR                      17</span><span style="color:#999;font-weight:bold;font-style:italic">
</span></code></pre></td></tr></table>
</div>
</div><p><strong>标量类型：</strong> 最简单的类型是true、false、long、double、null，其中true、false、null没有value，直接根据type区分，
而long、double的值则直接存在value中：zend_long、double，也就是标量类型不需要额外的value指针。</p>
<p><strong>字符串：</strong> PHP中字符串通过zend_string表示字符串。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">struct</span> _zend_string {
    zend_refcounted_h gc;
    zend_ulong        h;                <span style="color:#998;font-style:italic">/* hash value */</span>
    size_t            len;
    <span style="color:#458;font-weight:bold">char</span>              val[<span style="color:#099">1</span>];
};
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>gc</strong>： 变量引用信息，比如当前value的引用数，所有用到引用计数的变量类型都会有这个结构</li>
<li><strong>h</strong>： 哈希值，数组中计算索引时会用到</li>
<li><strong>len</strong>： 字符串长度，通过这个值保证二进制安全</li>
<li><strong>val</strong>： 字符串内容，变长struct，分配时按len长度申请内存</li>
</ul>
<p>事实上字符串又可具体分为几类：IS_STR_PERSISTENT(通过malloc分配的)、IS_STR_INTERNED(php代码里写的一些字面量，比如函数名、变量值)、IS_STR_PERMANENT(永久值，生命周期大于request)、IS_STR_CONSTANT(常量)、IS_STR_CONSTANT_UNQUALIFIED，
这个信息通过flag保存：zval.value-&gt;gc.u.flags，后面用到的时候再具体分析。</p>
<p><strong>数组：</strong> PHP中非常强大的一个数据结构，它的底层实现就是普通的有序HashTable：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">struct</span> _zend_array HashTable;

<span style="color:#000;font-weight:bold">struct</span> _zend_array {
    zend_refcounted_h gc; <span style="color:#998;font-style:italic">//引用计数信息，与字符串相同
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">union</span> {
        <span style="color:#000;font-weight:bold">struct</span> {
            ZEND_ENDIAN_LOHI_4(
                zend_uchar    flags,
                zend_uchar    nApplyCount,
                zend_uchar    nIteratorsCount,
                zend_uchar    reserve)
        } v;
        uint32_t flags;
    } u;
    uint32_t          nTableMask; <span style="color:#998;font-style:italic">//计算bucket索引时的掩码
</span><span style="color:#998;font-style:italic"></span>    Bucket           <span style="color:#000;font-weight:bold">*</span>arData; <span style="color:#998;font-style:italic">//bucket数组
</span><span style="color:#998;font-style:italic"></span>    uint32_t          nNumUsed; <span style="color:#998;font-style:italic">//已用bucket数
</span><span style="color:#998;font-style:italic"></span>    uint32_t          nNumOfElements; <span style="color:#998;font-style:italic">//已有元素数，nNumOfElements &lt;= nNumUsed，因为删除的并不是直接从arData中移除
</span><span style="color:#998;font-style:italic"></span>    uint32_t          nTableSize; <span style="color:#998;font-style:italic">//数组的大小，为2^n
</span><span style="color:#998;font-style:italic"></span>    uint32_t          nInternalPointer; <span style="color:#998;font-style:italic">//数值索引
</span><span style="color:#998;font-style:italic"></span>    zend_long         nNextFreeElement;
    dtor_func_t       pDestructor;
};
</code></pre></td></tr></table>
</div>
</div><p>PHP7对数组进行了极大的优化，缩小的数组所占字节数。</p>
<p><strong>对象/资源：</strong>
PHP的对象是一种复合型的数据，使用一种_zend_object的结构体来存放。其定义如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">struct</span> _zend_object {
    zend_refcounted_h gc;
    uint32_t          handle;
    zend_class_entry <span style="color:#000;font-weight:bold">*</span>ce; <span style="color:#998;font-style:italic">//对象对应的class类
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">const</span> zend_object_handlers <span style="color:#000;font-weight:bold">*</span>handlers;
    HashTable        <span style="color:#000;font-weight:bold">*</span>properties; <span style="color:#998;font-style:italic">//对象属性哈希表
</span><span style="color:#998;font-style:italic"></span>    zval              properties_table[<span style="color:#099">1</span>];
};

<span style="color:#000;font-weight:bold">struct</span> _zend_resource {
    zend_refcounted_h gc;
    <span style="color:#458;font-weight:bold">int</span>               handle;
    <span style="color:#458;font-weight:bold">int</span>               type;
    <span style="color:#458;font-weight:bold">void</span>             <span style="color:#000;font-weight:bold">*</span>ptr;
};
</code></pre></td></tr></table>
</div>
</div><p>对象比较常见，资源指的是tcp连接、文件句柄等等类型，这种类型比较灵活，可以随意定义struct，通过ptr指向。
PHP的对象只有在运行时才会被创建，全局的EG宏中保存了在运行时的数据。 其中就包括了用来保存所有被创建的对象的对象池，EG(objects_store)，
而object对象值内容的zend_object_handle域就是当前 对象在对象池中所在的索引，handlers字段则是将对象进行操作时的处理函数保存起来。
这个结构体及对象相关的类的结构_zend_class_entry，</p>
<p><strong>引用：</strong></p>
<p>引用是PHP中比较特殊的一种类型，它实际是指向另外一个PHP变量，对它的修改会直接改动实际指向的zval，可以简单的理解为C中的指针，
在PHP中通过&amp;操作符产生一个引用变量，也就是说不管以前的类型是什么，&amp;首先会创建一个zend_reference结构，其内嵌了一个zval，
这个zval的value指向原来zval的value(如果是布尔、整形、浮点则直接复制原来的值)，然后将原zval的类型修改为IS_REFERENCE，
原zval的value指向新创建的zend_reference结构。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">struct</span> _zend_reference {
    zend_refcounted_h gc;
    zval              val;
};
</code></pre></td></tr></table>
</div>
</div><p>PHP中的 引用只可能有一层 ，不会出现一个引用指向另外一个引用的情况 ，也就是没有C语言中指针的指针的概念。</p>
<h2 id="变量的内存管理">变量的内存管理</h2>
<p>内存管理，是指软件运行时对计算机内存资源的分配和使用的技术。其最主要的目的是如何高效，快速的分配，并且在适当的时候释放和回收内存资源。</p>
<p>在使用C/C++开发程序的时候，需要格外注意内存管理，申请了内存再使用完后要记得释放，否则可能会造成内存泄漏。如果程序需要常驻内存，那么内存泄漏问题会把机器的内存耗光。
所以在PHP这种需要常驻内存的程序来说，内存管理非常重要，它决定了程序的稳定性和执行效率。
另外，应用程序向系统申请内存，释放内存的时候会引发系统调用，系统调用提供用户程序与操作系统之间的接口，会触发0x80 号中断（int 0x80），
将CPU从用户态切换到内核态，执行完毕再切换回用户态。频繁在用户态和内核态切换会带来很大的性能消耗。
(所以PHP释放内存时候，并没有交还给操作系统，而是交还给进程了。)</p>
<p>最简单的内存管理方式就是，在赋值和传参的时候，每申请一个变量即分配一块内存空间，存放变量。这样在变量不使用的时候，直接free该变量即可。</p>
<p>但是，赋值和传参数每次都硬拷贝一个副本，会极大浪费内存空间。实际上目前复制主流的方案都是写时复制。
也就是只有当你需要修改数据的时候，才会真正的复制数据到一块新的空间上，否则就会直接使用原值的地址空间。</p>
<p>在这种情况下，内存管理就需要考虑到变量引用的情况。在PHP中对内存的回收使用的是引用计数的方式。</p>
<h2 id="引用计数">引用计数</h2>
<p>引用计数是指在value中增加一个字段refcount记录指向当前value的数量，变量复制、函数传参时并不直接硬拷贝一份value数据，
而是将refcount++，变量销毁时将refcount&ndash;，等到refcount减为0时表示已经没有变量引用这个value，将它销毁即可。</p>
<p>引用计数的信息位于给具体value结构的gc中：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#000;font-weight:bold">typedef</span> <span style="color:#000;font-weight:bold">struct</span> _zend_refcounted_h {
    uint32_t         refcount;          <span style="color:#998;font-style:italic">/* reference counter 32-bit */</span>
    <span style="color:#000;font-weight:bold">union</span> {
        <span style="color:#000;font-weight:bold">struct</span> {
            ZEND_ENDIAN_LOHI_3(
                zend_uchar    type,
                zend_uchar    flags,    <span style="color:#998;font-style:italic">/* used for strings &amp; objects */</span>
                uint16_t      gc_info)  <span style="color:#998;font-style:italic">/* keeps GC root number (or 0) and color */</span>
        } v;
        uint32_t type_info;
    } u;
} zend_refcounted_h;
</code></pre></td></tr></table>
</div>
</div><p>因为zval数据结构中，PHP中两个基础数据类型，int整型和浮点并非使用的指针，而是基础的C语言数据类型，所以直接上是不存在引用计数的。
这两个数据类型的复制都是硬拷贝。</p>
<p>事实上并不是所有的PHP变量都会用到引用计数，标量：TRUE/FALSE/DOUBLE/LONG/NULL，但是除了这几个还有两个特殊的类型也不会用到：INTERNED STRING(内部字符串，就是上面提到的字符串flag：IS_STR_INTERNED)、IMMUTABLE ARRAY（常量数组），
它们的type是IS_STRING、IS_ARRAY，STRING、ARRAY，那怎么区分一个value是否支持引用计数呢？</p>
<ol>
<li>理论上我们可以判断变量是否是以上几种类型，比如判断变量是否是TRUE，DOUBLE，LONG等等。</li>
<li>但是情况太多了，每次判断显得非常麻烦，PHP7引入了一个标志位， 叫做IS_TYPE_REFCOUNTED, 它会保存在zval.u1.v.type_flags中， 我们对于需要引用计数的类型就赋予这个标志。</li>
</ol>
<p>什么是interned string和immutable array呢？</p>
<blockquote>
<p>interned string： 内部字符串，这是种什么类型？我们在PHP中写的所有字符都可以认为是这种类型。比如function name、class name、variable name、静态字符串等等。
通俗来说你在脚本中定义的大多数字符串最后都需要编译运行，所以在运行时，这些字符串就已经存在了。且这部分值会不会修改的。</p>
<p>同理，immutable array 也是一些无法修改array，比如说PHP现在可以定义常量类型的数组了。这个数组类型就是immutable array</p>
</blockquote>
<h2 id="写时复制">写时复制</h2>
<p>多个变量可能指向同一个value，然后通过refcount统计引用数，这时候如果其中一个变量试图更改value的内容则会重新拷贝一份value修改，同时断开旧的指向，写时复制的机制在计算机系统中有非常广的应用，
它只有在必要的时候(写)才会发生硬拷贝，可以很好的提高效率。</p>
<p>不是所有类型都可以copy的，比如对象、资源就不行，实际上只有string、array两种支持，与引用计数相同，也是通过zval.u1.type_flag标识value是否可复制的 IS_TYPE_COPYABLE。</p>
<h2 id="变量回收">变量回收</h2>
<p>PHP变量的回收主要有两种：主动销毁、自动销毁。主动销毁指的就是 unset ，而自动销毁就是PHP的自动管理机制，在return时减掉局部变量的refcount，
即使没有显式的return，PHP也会自动给加上这个操作，另外一个就是写时复制时会断开原来value的指向，这时候也会检查断开后旧value的refcount。</p>
<h2 id="垃圾回收">垃圾回收</h2>
<p>PHP变量的回收是根据refcount实现的，当unset、return时会将变量的引用计数减掉，如果refcount减到0则直接释放value，这是变量的简单gc过程，
但是实际过程中出现gc无法回收导致内存泄漏的bug。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$a = [1];
$a[] = <span style="color:#800080">&amp;$a;</span>

unset($a);
</code></pre></td></tr></table>
</div>
</div><p>unset($a)之前引用关系：
<img src="/img/unset01.png" alt="引用变量" title="引用变量">
<img src="/img/unset02.png" alt="垃圾" title="垃圾变量"></p>
<p>可以看到，unset($a)之后由于数组中有子元素指向$a，所以refcount &gt; 0，无法通过简单的gc机制回收，这种变量就是垃圾，
垃圾回收器要处理的就是这种情况，目前垃圾只会出现在array、object两种类型中，所以只会针对这两种情况作特殊处理：
当销毁一个变量时，如果发现减掉refcount后仍然大于0，且类型是IS_ARRAY、IS_OBJECT则将此value放入gc可能垃圾双向链表中，
等这个链表达到一定数量后启动检查程序将所有变量检查一遍，如果确定是垃圾则销毁释放。</p>
<p>标识变量是否需要回收也是通过u1.type_flag区分的：<code>IS_TYPE_COLLECTABLE</code></p>
<h2 id="总结">总结</h2>
<p>通过这部分我们了解到PHP中变量是如何存储的。变量的类型是如何区分的。变量复制和引用是如何进行的。以及变量销毁的基本逻辑。<br>
接下来，重点关注一下PHP的最常用的数据结构Array的底层细节。</p>

        </div>

        


        


<div class="post-archive">
    <h2 style="border-top: 1px solid #eee;">See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/php-basic02/">PHP基础知识学习(02)--SAPI</a></li>
        
        <li><a href="/post/php-basic01/">PHP基础知识学习(01)--生命周期</a></li>
        
        <li><a href="/post/http-server-apache-work-mode/">Apache三种工作模式</a></li>
        
        <li><a href="/tutorial/how-to-create-you-own-blog/">使用Hugo&#43;GitHub Pages 搭建个人博客</a></li>
        
        <li><a href="/post/my-first-post/">博客开通啦！</a></li>
        
    </ul>
</div>



        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='https://xiangxihenli.github.io/tags/PHP'>PHP</a></li>
                
                <li><a href='https://xiangxihenli.github.io/tags/%E5%9F%BA%E7%A1%80'>基础</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://xiangxihenli.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://xiangxihenli.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://xiangxihenli.github.io/post/php-basic04/" title="PHP基础知识学习(04)--Array">PHP基础知识学习(04)--Array</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/post/php-basic03/" title="PHP基础知识学习(03)--变量">PHP基础知识学习(03)--变量</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/post/http-server-apache-work-mode/" title="Apache三种工作模式">Apache三种工作模式</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/post/php-basic02/" title="PHP基础知识学习(02)--SAPI">PHP基础知识学习(02)--SAPI</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/post/php-basic01/" title="PHP基础知识学习(01)--生命周期">PHP基础知识学习(01)--生命周期</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/tutorial/how-to-create-you-own-blog/" title="使用Hugo&#43;GitHub Pages 搭建个人博客">使用Hugo&#43;GitHub Pages 搭建个人博客</a>
    </li>
    
    <li>
        <a href="https://xiangxihenli.github.io/post/my-first-post/" title="博客开通啦！">博客开通啦！</a>
    </li>
    
</ul>

    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="https://xiangxihenli.github.io/categories/HTTP%E6%9C%8D%E5%8A%A1%E5%99%A8/">HTTP服务器 (1)</a></li>
    
    <li><a href="https://xiangxihenli.github.io/categories/PHP%E5%9F%BA%E7%A1%80/">PHP基础 (4)</a></li>
    
    <li><a href="https://xiangxihenli.github.io/categories/%E6%95%99%E7%A8%8B/">教程 (1)</a></li>
    
    <li><a href="https://xiangxihenli.github.io/categories/%E7%94%9F%E6%B4%BB/">生活 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://xiangxihenli.github.io/tags/Apache/">Apache</a>
    
    <a href="https://xiangxihenli.github.io/tags/HTTP/">HTTP</a>
    
    <a href="https://xiangxihenli.github.io/tags/HTTP-Server/">HTTP Server</a>
    
    <a href="https://xiangxihenli.github.io/tags/PHP/">PHP</a>
    
    <a href="https://xiangxihenli.github.io/tags/%E5%9F%BA%E7%A1%80/">基础</a>
    
    <a href="https://xiangxihenli.github.io/tags/%E6%95%99%E7%A8%8B/">教程</a>
    
    <a href="https://xiangxihenli.github.io/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://xiangxihenli.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="https://xiangxihenli.github.io">相惜恨离 By 相惜恨离</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-91862329-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>